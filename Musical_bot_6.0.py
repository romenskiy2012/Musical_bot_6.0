#pip3 install discord.py
#pip3 install youtube-dl
#pip3 install PyNaCl
#sudo apt install ffmpeg 
# on
#sudo pacman -S ffmpeg 
#pip3 install PyYAML




########################### –î–∏—Å–∫–æ—Ä–¥
import discord
import asyncio
from discord.ext import commands
from discord.utils import get
############################

############################

############################ –ú–æ–¥—É–ª–∏ –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤
#import youtube_dl

############################

############################ –°–∏—Å—Ç–µ–º–Ω—ã–µ –º–æ–¥—É–ª–∏
import os
from threading import Thread
from subprocess import call
from time import strftime, localtime, sleep #–î–ª—è (Time)

import time
import random
############################

############################ json –º–æ–¥—É–ª—å
import json
with open("sonf.json", "r") as read_file:
    X_Pars = json.load(read_file) 
############################


############################ sql –º–æ–¥—É–ª—å
SQL_Q = [[], [], [], [], [], []]

import sqlite3

bd = sqlite3.connect("bd/B.bd")
sql = bd.cursor()

naim = ["server","id","channel","channel_id","txt_1","txt_2"]
f = 0
while f != 6:
    sql.execute(f"SELECT {naim[f]} FROM fiel")
    SQL_Q_L = sql.fetchall()
    x = 0 
    for id_user in SQL_Q_L:
        SQL_Q[f].insert(x,id_user[0])
        x = x + 1
    f = f + 1

bd.close()
print("–î–∞–∑–∞")
print(SQL_Q[1][3])
print(SQL_Q[5][0])
############################

#################################### –õ–æ–∫–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏

#import add

#import handler
import youtube
import bd_module
import question
import download
####################################



### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
a = True
list = os.listdir()
for list_2 in list:
    if list_2 == "Music":
        print("–¢–∞–∫–æ–π —Ñ–∞–µ–ª –µ—Å—Ç—å!")
        a = False
if a == True:
    os.mkdir("Music")

#os.rmdir("Music")
#os.mkdir("Music")
#call(["rm", "-r", "Music"])
#call(["mkdir", "Music"])


print(X_Pars)
TOKEN = X_Pars['token']
bot = commands.Bot(command_prefix=X_Pars['prefix'])
client = discord.Client()
bot.remove_command("help")


###

Turn = [] # –û—á–µ—Ä–µ–¥–∏ –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
#Turn2 = [] # –û—á–µ—Ä–µ–¥–∏ –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.

sor = ()
video = ()
Question = [["001"], [], [], []] # –ó–∞–ø—Ä–æ—Å—ã.
#Question = [[233962119106789376,"001"], [769927691545215006], [785670323655016459], [False]] # –ó–∞–ø—Ä–æ—Å—ã.

volume1 = 0.2

async def sing_ddd(message):
    r2 = "https://cdn.discordapp.com/attachments/587366302780358688/806924319422152744/BOT_V6.0.webp"
    
    a = 0
    for id_lin in SQL_Q[3]: # –í —Ç–æ–º –ª–∏ —á–∞—Ç–µ ?
        if id_lin == message.channel.id:
            print(SQL_Q[5][a])
            qm2 = int(SQL_Q[5][a])
            qm = int(SQL_Q[4][a])
            channel_id = message.channel.id
        a = a + 1
        
        
            
    id_jgkihjkf = int(message.author.guild.id)
    msg_sa = await bot.get_guild(id_jgkihjkf).get_channel(channel_id).fetch_message(qm)
    bot.loop.create_task(msg_sa.edit(content=(r2)))
    
def checking_the_queue(message,voice):
    bd_module.deleting_a_queue(message) # –£–¥–æ–ª–µ–Ω–∏—è –∏–∑ –æ—á–µ—Ä–µ–¥–∏ —Ç—Ä–µ–∫–∞
    id = bd_module.reading_from_a_queue(message)
    if id == "001":
        bot.loop.create_task(sing_ddd(message))
        bot.loop.create_task(voice.disconnect())
        #pass
    else:
        #bot.loop.create_task(sing(message,sasss))
        sing(message,id)

async def sing_k8ifg4(id, name_2, volume, time, views, estimation, date, message):
    r1 = (f"https://i.ytimg.com/vi/{id}/hqdefault.jpg")
    
    
    
    a = 0
    for id_lin in SQL_Q[3]: # –í —Ç–æ–º –ª–∏ —á–∞—Ç–µ ?
        if id_lin == message.channel.id:
            print(SQL_Q[5][a])
            qm2 = int(SQL_Q[5][a])
            qm = int(SQL_Q[4][a])
            channel_id = message.channel.id
        a = a + 1
        
        
            
    id_jgkihjkf = int(message.author.guild.id)
    msg_sa = await bot.get_guild(id_jgkihjkf).get_channel(channel_id).fetch_message(qm)
    bot.loop.create_task(msg_sa.edit(content=(r1)))
    
    msg_sa = await bot.get_guild(id_jgkihjkf).get_channel(channel_id).fetch_message(qm2)
    lll = f"{name_2}\nüëÄ {views} üëç {estimation} üóìÔ∏è {date}"
    bot.loop.create_task(msg_sa.edit(content=(lll)))
    
#async def sing(message,sasss):
def sing(message,id):
    print(id)

    id, name_2, volume, time, views, estimation, date = bd_module.search_ID(id)
    
    bot.loop.create_task(sing_k8ifg4(id, name_2, volume, time, views, estimation, date, message))
    #sing_k8ifg4(id, name_2, volume, time, views, estimation, date, message)
    
    sasss = f"Music/{id}.opus"

    msg = bot.get_guild(message.author.guild.id)
    voice = get(bot.voice_clients, guild=msg)

    voice.play(discord.FFmpegPCMAudio(sasss), after = lambda x: checking_the_queue(message,voice))
    voice.source = discord.PCMVolumeTransformer(voice.source)
    voice.source.volume = volume1

    







async def messenger(message,url):
    msg = bot.get_guild(message.author.guild.id)
    channel = message.author.voice.channel
    voice = get(bot.voice_clients, guild=msg)
    print("222")
    if youtube.start(url):
        print("222")
        print("–≠—Ç–æ —é—Ç—É–±!")
        if youtube.start_list(url):# –û—á–µ—Ä–∏–¥—å –ª–∏ ?
            pass
        else:
            id = download.youtube_d(url,message)
            #youtube.don(url)# –°–∫–∞—á–∞—Ç—å
            print("–ì–æ—Ç–æ–≤–æ")
            if voice and voice.is_connected():
                # –¥–æ–±–∞–≤–∏—Ç—å –≤ –±–∞–∑—É
                print("–¥–æ–±–∞–≤–∏—Ç—å –≤ –±–∞–∑—É")
                await voice.move_to(channel)
            else:
                voice = await channel.connect()
                print(f"–ë–æ—Ç –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –∫ {channel}\n")
                #bot.loop.create_task(sing(message,sasss))
                sing(message,id)

    else:
        print("–≠—Ç–æ –Ω–µ —é—Ç—É–±!")




### –í—ã–¥–µ–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–∞–Ω–∞–ª –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤.
### –ï—Å–ª–∏ –≤—ã –∑–Ω–∞–µ—Ç–µ –∫–∞–∫ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∞—Å–∏–Ω–æ—Ö–æ–Ω–Ω—É—é –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å.
### !–°–æ–æ–±—à–∏—Ç–µ!







########################

def http(url, Turn, id, id_channel, message):
    global Question
    url_index = []
    print (url)
    
    url_index.extend(url)
    url_index.append ("001")
    x = 0
    if url_index[x] == "h":
        if url_index[x + 1] == "t":
            if url_index[x + 2] == "t":
                if url_index[x + 3] == "p":
                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –≤–æ–ø—Ä–æ—Å–∞
                    user_id = message.author.id
                    id_question = question.start(Question, user_id, id)
                    if id_question != False:
                        # –£–¥–æ–ª–∏—Ç—å id_question
                        #

                        #  –£–¥–æ–ª–∏—Ç—å —Å–æ–æ–±—à–µ–Ω–∏–µ —Å –≤–æ–ø—Ä–æ—Å–æ–º.
                        pass
                    print(Question)

                    # –ß—Ç–æ –∑–∞ —Å–µ—Ä–≤–∏—Å ?
                    bot.loop.create_task(messenger(message,url))






#######################





########################
def command(message):


    if message.content == "/add":
        bot.loop.create_task(add(message))
    if message.content == "/test":
        bot.loop.create_task(test(message))

async def test(message):
    channel = message.channel
    await channel.send("–¢—É—Ç!")

async def add(message):
    await message.delete()
    print(message.author.guild.name)# –ò–º—è 
    print(message.author.guild.id)# –ê–π–¥–∏
    print(message.channel.name)# –ò–º—è
    print(message.channel.id)# –ê–π–¥–∏
    msg = bot.get_guild(message.author.guild.id).get_channel(message.channel.id)
    channel = message.channel
    await channel.send("–ü—Ä–∏–≤–µ—Ç")
    sleep(1)
    txt_1 = (channel.last_message_id)
    msg = await bot.get_guild(message.author.guild.id).get_channel(message.channel.id).fetch_message(txt_1)
    emoji = "‚è∏Ô∏è"
    await msg.add_reaction(emoji)
    emoji = "‚ñ∂Ô∏è"
    await msg.add_reaction(emoji)
    emoji = "‚è©"
    await msg.add_reaction(emoji)
    emoji = "‚è≠Ô∏è"
    await msg.add_reaction(emoji)
    emoji = "‚èπÔ∏è"
    await msg.add_reaction(emoji)
    emoji = "üîÑ"#–ü–æ–≤—Ç–æ—Ä
    await msg.add_reaction(emoji)
    emoji = "üîä"
    await msg.add_reaction(emoji)
    emoji = "üîâ"
    await msg.add_reaction(emoji)
    print(channel.last_message_id)
    



    await channel.send("–ü—Ä–∏–≤–µ—Ç2")
    sleep(1)
    txt_2 = (channel.last_message_id)
    print(channel.last_message_id)

    bd_module.add(message,Turn,txt_1,txt_2,SQL_Q)
    print("–°–ê–°!")



########################




### –°—Ç–∞—Ä—Ç –±–æ—Ç–∞.
@bot.event
async def on_ready():
    print("–ë–æ—Ç –æ–Ω–ª–∞–π–Ω!!!")


@bot.event # –°–ª—É—à–∞–µ—Ç.
async def on_message(message):
    chat = False
    print("–î–∞ ?")
    if message.content.startswith('/'): # –ö–æ–º–∞–Ω–¥–∞ ?
        command(message)
        pass

    else:
        for id_lin in SQL_Q[3]: # –í —Ç–æ–º –ª–∏ —á–∞—Ç–µ ?
            if id_lin == message.channel.id:
                chat = True

        if chat == True:
            await message.delete()
            if message.content == (''):# –≠—Ç–æ —Ñ–∞–µ–ª ?
                pass

            if message.content == ('1'):# –≠—Ç–æ —Ü–∏—Ñ—Ä—ã –¥–ª—è –ø–µ—Ä–µ–º–æ–¥–∫–∏ ?
                pass

            elif message.content.startswith('y') or message.content.startswith('Y') or message.content.startswith('n') or message.content.startswith('N'):# –û—Ç–≤–µ—Ç ?
                pass


            elif message.author.id == X_Pars['bot_id']:# –ë–æ—Ç ?
                pass

            
            elif message.content != (''):
                id = message.author.guild.id
                id_channel = message.channel.id
                url = message.content
                
                print(url)
                variable = Thread(target=http, args=(url, Turn, id, id_channel, message))
                variable.start()




















@bot.event
async def on_raw_reaction_add(reaction):
    global volume1, repeat
    print(reaction.user_id)
    print(f"{reaction.member.display_name}#{reaction.member.discriminator}")
        
        
    #print(user.id)
    #msg_2 = bot.get_guild(int(X_Pars["guild_id"]))
    msg = bot.get_guild(reaction.member.guild.id)
    #if user.id != X_Pars["bot_id"]:
    #print(msg.author.id)
    user234id = True
    print(reaction.user_id)
    admin_list = X_Pars['admin_list']
    admin_list.append("001")
    a = 0
    #while admin_list[a] != "001":
        #if reaction.user_id == admin_list[a]:
    
    print("123")
    #ctx = ("pause")
    #await reaction.clear_reaction(reaction)
    #def on_track_end2(error):
    #    bot.loop.create_task(bot.send(":white_check_mark: –°–∫–∞—á–∞–Ω–æ!"))
    #await ctx.send(reaction) #–æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ –∞—Ä–≥—É–º–µ–Ω—Ç

    #await reaction.message.channel.send(reaction)
    #print(on_reaction_add)
    
    #voice = get(bot.voice_clients, guild=reaction.message.guild)
    voice = get(bot.voice_clients, guild=msg)
    #print(reaction)
    #await ('Say hello!')
    #on_track_end2
    #await reaction.message.send('Hello World!')
    print("1")
    print(reaction.emoji)
    if (str(reaction.emoji) == "‚è∏Ô∏è"):
        #print("2")
        voice.pause()
        print("–ü–∞—É–∑–∞")
        
    if (str(reaction.emoji) == "‚èØÔ∏è"):
        print("–°–µ—Ä–¥—Ü–µ")
    if (str(reaction.emoji) == "‚ñ∂Ô∏è"):
        print("–ü–ª–µ–π")
        voice.resume()
    if (str(reaction.emoji) == "‚è©"):
        print("–ü—Ä–æ–ø—É—Å–∫")
        voice.stop()
    if (str(reaction.emoji) == "‚è≠Ô∏è"):
        print("–ü—Ä–æ–ø—É—Å–∫ –ø–ª–µ–π –ª–∏—Å—Ç–∞.")
        global m11
        m11 = 1
        voice.stop()
    if (str(reaction.emoji) == "‚èπÔ∏è"):
        print(reaction.emoji)
        global f
        f = ["123", "001"]
        #voice.disconnect()
        voice.stop()
    if (str(reaction.emoji) == "üîÑ"):
        if repeat == True:
            repeat = False
        else:
            repeat = True
        print(reaction.emoji)
        print("üîÇ")
        print("‚û°Ô∏è")
        
    if (str(reaction.emoji) == "üîä"):
        volume1 = volume1 + 0.1
        volume1 = round(volume1, 1)
        print(volume1)
        if volume1 > 1:
            volume1 = volume1 - 0.1
        else:
            voice.source.volume = volume1
    if (str(reaction.emoji) == "üîâ"):
        volume1 = volume1 - 0.1
        volume1 = round(volume1, 1)
        print(volume1)
        if volume1 < 0.1:
            volume1 = volume1 + 0.1
        else:
            voice.source.volume = volume1
        print("3")

bot.run(TOKEN)
